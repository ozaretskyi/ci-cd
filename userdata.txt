#!/bin/bash -xe
sed -i 's/Defaults[ ]*requiretty/#Defaults requiretty/g' /etc/sudoers
yum update -y
yum -y install epel-release
yum makecache fast
yum -y update
yum -y install python-boto
yum -y install python-pip
pip install awscli --upgrade
yum install ansible -y
yum clean all

JENKINS_URL='http://172.31.49.85:8080'
TOKEN='bootstrapme'
NEW_HOST_FQDN='curl -s http://169.254.169.254/latest/meta-data/public-ipv4'
NEW_HOST_ID='curl -s http://169.254.169.254/latest/meta-data/instance-id'
NEW_HOST_REGION='us-east-1'
JOB_PARAMS="$JOB_PARAMS&NEW_HOST_FQDN=$NEW_HOST_FQDN"
JOB_PARAMS="$JOB_PARAMS&NEW_HOST_ID=$NEW_HOST_ID"
JOB_PARAMS="$JOB_PARAMS&NEW_HOST_REGION=$NEW_HOST_REGION"
JOB_URL="job/bootstrap-aws-instance/buildWithParameters?token=$TOKEN$JOB_PARAMS"
URL="$JENKINS_URL/$JOB_URL"

echo "#!/bin/bash" > /root/provision.sh
echo "URL=\"$URL\"" >> /root/provision.sh
echo "sleep 60" >> /root/provision.sh
echo "while true ; do STATUSCODE=$(curl -X POST --silent --connect-timeout 60  --max-time 600 --output "/tmp/curltmp1" --write-out "%{http_code}" "$URL"  ); if test $STATUSCODE -ne 201; then echo "Status code $STATUSCODE not 201!"; sleep 30; else break; fi || break; done" >> /root/provision.sh
chmod 755 /root/provision.sh
nohup bash /root/provision.sh &
